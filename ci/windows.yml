steps:
- script: |
    node bin.js version
  displayName: Print Flossbank version
- powershell: |
    . ci/exec.ps1
    $ErrorActionPreference = "Stop"

    echo "Setting API key"
    exec { node ci/configure.js }

    echo "Setting API host to staging"
    exec { patch -u src/constants.js -i ci/constants.patch }
    exec { npm run build }

    echo "Testing install with ads"
    pushd ci/example
    $env:DEBUG="flossbank"
    exec { node ../../bin.js npm install } ../install_log.txt
    popd

    echo "Install log:"
    cat ci/install_log.txt

    echo "Validating ads were shown"
    exec { node ci/validateInstall.js }
  displayName: Test ads during install
